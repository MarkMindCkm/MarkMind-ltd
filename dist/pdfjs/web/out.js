window.addEventListener("load",function(){var l,d,c,p,s="255,255,0",u=[],g="",h=null,m=[],i="",r="",f="",v=!1,w=0,b=0,I=0,A=0,k="",L="",S="",C=1,E=!1,T=!0,M="",P=null,q=!1,D="",o=new Image;o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAQCAYAAAD0xERiAAAAAXNSR0IArs4c6QAAAWNJREFUOE+tlL1Lw1AUxc8RN/O6Fmf7Hzg0uPgCTqK4OYgfmx9NJ1Fw7Kago6mKCH5Nbjqog5DgYkT/hDhLV1M3yZUEWmpIUyu+5T3uPefH4V3eIwDYWt0AmAZwSpEXIR2KzMY9Ia/iPW8JcVx3w2VWdeEgQtSoe81aL1O3fkUbNQoVba3E8UL+FRT7qtrQAt79gIlfcgHoPsAezcDqBpM+QImUZsBc2HvjKxEOFweT/fbhE5MTQ8k53esJi83xagGqWw3s7xTb4M5eT9i/Juvn3vKSvQIY/TWMeGI5GMscQBoifmkBwHlHfZFmcJHWtWEVrR4JnDheeJaVSPyRDYC7gGzSfNvL0thaLVFkjpVxwyK5DmAqJXx2vNBMm22tfADlVP0ekWx3fUa2Ni5BKscNZ1pG21LXEAkdrzmflTD3TdpWIfkxKFFdOLAWHx33I/lN+obFBlurQwArAI4cL1zNm/Q35w3C3z6JOu0AAAAASUVORK5CYII=";var V={"zh-cn":{page:"页"},zn:{page:"Page"}};Element.prototype.hasClass=function(e){return this.classList.contains(e)};let B='<svg t="1632228228676"  viewBox="0 0 1214 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15810" width="12" height="12"><path d="M964.352982 196.442274H250.01744A53.575166 53.575166 0 0 0 196.442274 250.01744v339.309382A53.575166 53.575166 0 0 0 250.01744 642.901988h214.300663l117.508196 117.508197a35.716777 35.716777 0 0 0 50.717824 0L750.052319 642.901988h214.300663a53.575166 53.575166 0 0 0 53.575166-53.575166V250.01744A53.575166 53.575166 0 0 0 964.352982 196.442274z" fill="#FFC824" p-id="15811"></path><path d="M607.185211 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM383.955354 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM830.415068 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM361.453784 71.433554h-17.858388a35.716777 35.716777 0 0 1 0-71.433554h17.858388a35.716777 35.716777 0 0 1 0 71.433554z" fill="#6B400D" p-id="15812"></path><path d="M607.185211 1024a107.150331 107.150331 0 0 1-75.719567-31.430764l-153.224974-153.224974H142.867108a142.867108 142.867108 0 0 1-142.867108-142.867108V142.867108a142.867108 142.867108 0 0 1 142.867108-142.867108h53.575166a35.716777 35.716777 0 0 1 0 71.433554H142.867108a71.433554 71.433554 0 0 0-71.433554 71.433554v553.610046a71.433554 71.433554 0 0 0 71.433554 71.433554h250.01744a35.716777 35.716777 0 0 1 25.358912 10.357865l163.582839 163.940007a35.716777 35.716777 0 0 0 50.717824 0l163.582839-163.940007a35.716777 35.716777 0 0 1 25.358912-10.357865h250.01744a71.433554 71.433554 0 0 0 71.433554-71.433554V142.867108a71.433554 71.433554 0 0 0-71.433554-71.433554H535.751657a35.716777 35.716777 0 0 1 0-71.433554h535.751657a142.867108 142.867108 0 0 1 142.867108 142.867108v553.610046a142.867108 142.867108 0 0 1-142.867108 142.867108h-235.373562l-153.224973 153.224974a107.150331 107.150331 0 0 1-75.719568 31.430764z" fill="#6B400D" p-id="15813"></path></svg>';document.querySelector(".icon-toggle"),document.querySelector(".viewerSider"),document.querySelector(".icon-zoomIn"),document.querySelector(".icon-zoomOut");var _=document.querySelector(".annotate-menu"),z=this.document.querySelector(".annotate-highlight"),F=document.querySelector(".viewerSiderAnnotate");document.querySelector(".icon-createImage"),document.querySelector(".icon-info");let R=document.getElementById("viewerContainer");var N=document.querySelector(".add-comment"),O=N.querySelector("textarea"),W=document.querySelector(".annotate-translate"),H=document.querySelector(".annotate-translate-content"),Y=null,J=null,K=null,U=2,X=[];$("body").on("click","#viewThumbnail",function(){$(".viewerSiderAnnotate").addClass("hidden"),$("#thumbnailView").removeClass("hidden"),$("#outlineView").addClass("hidden"),$("#showAnnotation").removeClass("toggled")}),$("body").on("click","#viewOutline",function(){$(".viewerSiderAnnotate").addClass("hidden"),$("#thumbnailView").addClass("hidden"),$("#outlineView").removeClass("hidden"),$("#showAnnotation").removeClass("toggled")}),$("body").on("click","#showAnnotation",function(){$(".viewerSiderAnnotate").removeClass("hidden"),$("#thumbnailView").addClass("hidden"),$("#outlineView").addClass("hidden"),$("#viewThumbnail").removeClass("toggled"),$("#viewOutline").removeClass("toggled"),$(this).addClass("toggled"),Ae()});var e=document.querySelector("#viewerContainer"),a=!1;function Q(e){var t;for(t of F.children)t.classList.remove("active"),e&&t.getAttribute("data-id")==e&&t.classList.add("active")}e.onscroll=function(){a||(ie(),Q())};var j="",G=!1,Z={},ee=[];function te(e){if(e.stopPropagation(),e.preventDefault(),se=null,h&&"ink"==h.type&&Y&&(Y._drag=!0),e.target.closest(".selectBoxRexize")&&(G=!0,j=e.target.closest(".selectBoxRexize").getAttribute("data-direct"),Z={x:parseFloat(Y.style.left),y:parseFloat(Y.style.top),w:parseFloat(Y.style.width),h:parseFloat(Y.style.height)}),x=(e.touches?e.touches[0]:e).clientX,y=(e.touches?e.touches[0]:e).clientY,sx=parseFloat(Y.style.left),sy=parseFloat(Y.style.top),ee=[],h){e=h.position.paths;if(e&&e.length)for(var t of e)ee.push(t.slice());R.ontouchmove=n,R.onmousemove=n,R.ontouchend=ne,R.onmouseup=ne}}function n(e){var t,n;e.preventDefault(),G&&(_.style.display="none","up"==j||"bottom"==j?(t=(e.touches?e.touches[0]:e).clientY,b=t-y,"up"==j?(Y.style.top=Z.y+b+"px",Y.style.height=Z.h-b+"px"):Y.style.height=Z.h+b+"px"):(n=(e.touches?e.touches[0]:e).clientX,w=n-x,"left"==j?(Y.style.left=Z.x+w+"px",Y.style.width=Z.w-w+"px"):Y.style.width=Z.w+w+"px")),Y&&Y._drag&&(e.preventDefault(),_.style.display="none",n=(e.touches?e.touches[0]:e).clientX,e=(e.touches?e.touches[0]:e).clientY,w=n-x,b=e-y,Y.style.left=sx+w+"px",Y.style.top=sy+b+"px")}function ne(e){if(Y&&(Y._drag=!1),R.onmousemove=null,R.ontouchmove=null,R.ontouchend=null,R.onmouseup=null,h){var t=PDFViewerApplication.pdfViewer._pages[h.position.pageIndex];if(G){var n=parseFloat(Y.style.left),o=parseFloat(Y.style.top),a=parseFloat(Y.style.width),i=parseFloat(Y.style.height),i=Se({pageIndex:h.position.pageIndex,rects:[[n+6,o+6,n+6-12+a,o+6+i-12]]},t.viewport);return h.position.rects=[i.rects[0].slice()],j="",G=!1,we(h),void ie()}var t=Se({pageIndex:h.position.pageIndex,rects:[[sx,sy,sx+w,sy+b]]},t.viewport).rects[0],r=Math.abs(t[2]-t[0])*w/Math.abs(w),s=Math.abs(t[3]-t[1])*b/Math.abs(b);if(r&&s){var l,d=[];for(l of ee){var c=[];for(let e=0;e<l.length;e+=2){var p=l[e]+r,u=l[e+1]-s;c.push(p),c.push(u)}d.push(c)}h.position.paths=d}b=w=0,we(h),ie()}}function oe(t){var e,n=ae.find(e=>e.pageIndex==t.position.pageIndex);n&&(N.style.display="none",e=Ce(t.position),(e=getAnnotationBox(e))&&((Y=document.createElement("div")).classList.add("selectBox"),n.page.originalPage.div.appendChild(Y),Y.innerHTML=`
		<div class="selectBoxRexize selectBoxRexizeUp" data-direct="up">
      <svg t="1693476083793"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="8438" width="16" height="16">
        <path
          d="M759.466667 533.333333L469.333333 243.2l29.866667-29.866667 320 320-320 320-29.866667-29.866666 290.133334-290.133334z m-298.666667 0L170.666667 243.2l29.866666-29.866667 320 320L200.533333 853.333333l-29.866666-29.866666 290.133333-290.133334z"
          fill="#444444" p-id="8439"></path>
      </svg>
    </div>

    <div class="selectBoxRexize selectBoxRexizeRight" data-direct="right">
      <svg t="1693476083793"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="8438" width="16" height="16">
        <path
          d="M759.466667 533.333333L469.333333 243.2l29.866667-29.866667 320 320-320 320-29.866667-29.866666 290.133334-290.133334z m-298.666667 0L170.666667 243.2l29.866666-29.866667 320 320L200.533333 853.333333l-29.866666-29.866666 290.133333-290.133334z"
          fill="#444444" p-id="8439"></path>
      </svg>
    </div>

    <div class="selectBoxRexize selectBoxRexizeBottom" data-direct="bottom">
      <svg t="1693476083793"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="8438" width="16" height="16">
        <path
          d="M759.466667 533.333333L469.333333 243.2l29.866667-29.866667 320 320-320 320-29.866667-29.866666 290.133334-290.133334z m-298.666667 0L170.666667 243.2l29.866666-29.866667 320 320L200.533333 853.333333l-29.866666-29.866666 290.133333-290.133334z"
          fill="#444444" p-id="8439"></path>
      </svg>
    </div>

    <div class="selectBoxRexize selectBoxRexizeLeft" data-direct="left">
      <svg t="1693476083793"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="8438" width="16" height="16">
        <path
          d="M759.466667 533.333333L469.333333 243.2l29.866667-29.866667 320 320-320 320-29.866667-29.866666 290.133334-290.133334z m-298.666667 0L170.666667 243.2l29.866666-29.866667 320 320L200.533333 853.333333l-29.866666-29.866666 290.133333-290.133334z"
          fill="#444444" p-id="8439"></path>
      </svg>
    </div>
		`,Y.style.left=e.x1-6+"px",Y.style.top=e.y1-6+"px",Y.style.width=Math.abs(e.x2-e.x1)+12+"px",Y.style.height=Math.abs(e.y2-e.y1)+12+"px",Y.style.display="block",Y.classList.contains("resize")&&Y.classList.remove("resize"),t&&"image"==t.type&&Y.classList.add("resize"),setTimeout(()=>{Y.onmousedown=te,Y.ontouchstart=te},E?400:0)))}window.toggleEditor=function(e){let t=(e=e||window.event).target||e.srcElement;if(t&&t.closest(".editorBtn")){var n=t.closest(".editorBtn");if(t.closest(".annoate-btn")){var o=t.closest(".annoate-btn").getAttribute("data-color");return n.querySelector("span").style.backgroundColor=`rgb(${o})`,n.querySelector("ul").style.display="none",void(s=o)}var a=n.parentElement.children;for(let e=0;e<a.length;e++)a[e]!=n&&a[e].classList.remove("active");n.classList.contains("addColor")?(o=n.querySelector("ul").style.display,n.querySelector("ul").style.display="flex"==o?"none":"flex"):(n.classList.contains("active")?(r="",n.classList.remove("active")):(r=n.getAttribute("data-type"),n.classList.add("active")),K=J=null)}};var ae=[];function ie(){_.style.display="none",N.style.display="none",W.style.display="none",z.style.display="none",h=null,v=!1,Y&&(Y.parentElement&&Y.parentElement.removeChild(Y),Y.onmousedown=null,Y.ontouchstart=null,Y=null),m.length&&m.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),m=[],h=null,de={}}z.onclick=function(e){e=e.target.closest(".annoate-btn");e&&("highlight"!=(e=e.getAttribute("data-type"))&&"underline"!=e&&"strokeout"!=e||xe(e),"copytext"==e&&(e=h&&-1<["highlight","underline","strokeout"].indexOf(h.type)?h.text:q||v?ce.selectText:de.current[0].text,window.parent.postMessage({type:"copyText",text:e,_viewMark:g},"*"),ie()))},_.onclick=e=>{var t,n,o,a,i=e.target.closest(".annoate-btn");i&&("highlight"==(t=i.getAttribute("title"))?(n=i.getAttribute("data-color"),h?(o=h.id,h.color=`rgb(${n})`,h.dateModified=Date.now(),u.forEach(e=>{e.id==o&&(e.color=`rgb(${n})`)}),we(h),Ie(),ie()):xe()):"comment"==t||("delete annotate"==t?h&&(function(){{var n,o;h&&(n=h.id,o=null,u.forEach((e,t)=>{e.id==n&&(u.splice(t,1),o=e)}),we(o),Ie())}}(),ie()):"copy text"==t?(i=h&&-1<["highlight","underline","strokeout"].indexOf(h.type)?h.text:q||v?ce.selectText:de.current[0].text,window.parent.postMessage({type:"copyText",text:i,_viewMark:g},"*"),ie()):"add note"==t&&(e=e.touches?(a=e.touches[0].pageX,e.touches[0].pageY):(a=e.pageX,e.pageY),-1<["highlight","underline","strokeout","image"].indexOf(h.type)&&(N.style.left=`${a-140}px`,N.style.top=`${e+20}px`,N.style.display="block",N.selectId=h.id,u.forEach(e=>{e.id==N.selectId&&(e.comments&&(O.value=e.comments),O.focus())})))))},document.onkeydown=function(e){var t=e.altKey,n=e.ctrlKey||e.metaKey;if(!t||"y"!=e.key&&"Y"!=e.key||xe("","247,255,0"),!t||"g"!=e.key&&"G"!=e.key||xe("","125,240,102"),!t||"b"!=e.key&&"B"!=e.key||xe("","143,222,249"),!t||"p"!=e.key&&"P"!=e.key||xe("","247,153,209"),!t||"r"!=e.key&&"R"!=e.key||xe("","253,73,73"),!t||"w"!=e.key&&"W"!=e.key||(o=document.querySelector(".editorBtn.addImage"))&&o.click(),!t||"e"!=e.key&&"E"!=e.key||(o=document.querySelector(".editorBtn.addInk"))&&o.click(),n&&("c"==e.key||"C"==e.key)){if("block"==N.style.display)return;(o=document.querySelector(".annoate-btn.copy"))&&o.click();n=document.querySelector(".annotate-highlight .copy2");n&&n.click()}var o,e=e.key.toLowerCase();!t||"delete"!=e&&"backspace"!=e||(o=document.querySelector(".annoate-btn.delete"))&&o.click()},F.onclick=e=>{var t=e.target.closest(".annotate-item");if(t){var n=t.getAttribute("data-id"),t=document.querySelector(".annotate-item.active");if(t){if(e.target.closest(".annotate-item-note"))return;t.classList.remove("active"),t.querySelector(".annotate-item-note").blur(),t.querySelector(".annotate-item-note").setAttribute("contenteditable",!1)}t=document.querySelector(`.annotate-item[data-id="${n}"]`);t&&t.classList.add("active"),t.querySelector(".annotate-item-note").setAttribute("contenteditable",!0),ie(),qe(n)}},window.addEventListener("message",function(n){switch(n.data.type){case"openPDF":n.data._viewMark&&(g=n.data._viewMark),ae=[],u=[];try{k=n.data.pdfName,L=n.data.basename,n.data.openProtocol,i=n.data.id,E=n.data.isMobile,S=n.data.mdPath,M=n.data.imageFolder,D=n.data.language,f=n.data.mdId,l=n.data.useTranslate,d=n.data.translateAppId,c=n.data.translateKey,p=n.data.translateType,n.data.top&&(I=n.data.top),n.data.bottom&&(I=n.data.bottom),T&&(E?(R.addEventListener("touchstart",le),R.addEventListener("touchmove",he),R.addEventListener("touchend",ye),R.addEventListener("mousedown",le),R.addEventListener("mousemove",he),R.addEventListener("mouseup",ye)):(R.addEventListener("pointerdown",le),R.addEventListener("pointermove",he),R.addEventListener("pointerup",ye),R.addEventListener("dragstart",e=>{e.preventDefault()})),T=!1),setTimeout(function(){PDFViewerApplication&&(PDFViewerApplication.open(n.data.data).then(()=>{try{window.pdfViewer=PDFViewerApplication.pdfViewer,window.extractor=new Extractor(pdfViewer),pdfViewer._currentPage=1,setTimeout(()=>{var e,t=n.data.annotations;t.length&&((e=t[0]).selectText||e.hasOwnProperty("page")?(t.forEach(e=>{if(e.text)try{var t=JSON.parse(e.text),n={id:e.id,type:"rect"==e.type?"image":"highlight",position:{pageIndex:e.page},color:t.color?`rgb(${t.color.r},${t.color.g},${t.color.b})`:"",pdfName:e.pdfName};if(t.path&&(n.path=t.path),t.imageAbsolutePath&&(n.imageAbsolutePath=t.imageAbsolutePath),t.contents&&(n.comments=t.contents),t.selectText?n.text=t.selectText:n.text="",e.createTime?n.dateCreated=e.createTime:n.dateCreated=Date.now(),e.commentTime&&(n.commentTime=n.commentTime),n.dateModified=Date.now(),t.relateRect){var i=[],r=PDFViewerApplication.pdfViewer._pages[e.page];if(!r)return;t.relateRect.forEach(e=>{var t=r.div.clientWidth,n=e.x*t,o=e.y*t,a=e.width*t,t=e.height*t;i.push([n,o,n+a,o+t])});var o=Se({pageIndex:e.page,rects:i},r.viewport);n.position.rects=o.rects,u.push(n)}}catch(e){console.log(e)}}),Ie()):u=t.slice()),Ae(),setTimeout(()=>{ae.forEach(e=>{e.page._annotations=u,e.page.render()}),n.data.id&&qe(n.data.id)},200)},1200),PDFViewerApplication.pdfDocument.getData().then(e=>{E||(P=new pdfAnnotate.AnnotationFactory(e)),pdfViewer.currentScaleValue="page-width"}),n.data.id&&qe(n.data.id)}catch(e){}}).catch(function(e){}),PDFViewerApplication.eventBus.on("pagerendered",Pe))},1e3)}catch(e){}break;case"closePDF":break;case"showAnnotate":qe(n.data.id);break;case"showAnnotateByJson":var e=n.data.json;s=e,pdfViewer.currentPageNumber=parseInt(s.position.pageIndex)+1,setTimeout(()=>{var n,t,o=document.querySelector(`#viewer .page[data-page-number="${s.position.pageIndex+1}"]`).querySelector(".canvasWrapper"),e=o.clientWidth,a=o.clientHeight,i=e/s.pageWidth,e=s.position.rects,r=[];e.forEach(e=>{var t=e[2]-e[0],n=e[3]-e[1];r.push({x:e[0]*i,y:a-e[1]*i-n*i,w:t*i,h:n*i})}),r&&(n=[],r.forEach(e=>{var t=document.createElement("div");t.classList.add("mm-temp-highlight"),t.style.left=e.x+"px",t.style.top=e.y+"px",t.style.width=e.w+"px",t.style.height=e.h+"px",t.style.backgroundColor="rgb(247, 255, 0,0.3)",t.style.position="absolute",n.push(t),o.appendChild(t)}),t=parseInt(n[0].style.top),setTimeout(()=>{var e=document.querySelector("#viewerContainer");e.scrollTop=e.scrollTop+t-60,setTimeout(()=>{n.forEach(e=>{o.removeChild(e)})},1e3)},100))},30);break;case"exportAnnotatePDF":var t;document.querySelector("#viewer .page").clientWidth,new Date;setTimeout(()=>{u.forEach(e=>{if(P){var t;1!=C&&P.deleteAnnotation(e.id),t=e.color&&e.color.startsWith("rgb")?(t=e.color.substring(4,e.color.length-1)).split(","):[247,255,0];var l={page:e.position.pageIndex,contents:function(e){let t=[];for(var n of e)n=n.charCodeAt(0),t.push(String.fromCharCode(n>>8)),t.push(String.fromCharCode(255&n));return"þÿ"+t.join("")}(e.comments||""),author:"",color:{r:parseFloat(t[0]),g:parseFloat(t[1]),b:parseFloat(t[2])},opacity:.8,id:e.id,quadPoints:[],fill:"",font:"Noto Sans CJK SC Medium"};if("highlight"==e.type||"underline"==e.type||"strokeout"==e.type||"image"==e.type)e.position.rects.forEach(e=>{var t=e[0],n=e[3],o=e[2],a=e[3],i=e[2],r=e[1],s=e[0],e=e[1];l.quadPoints.push(t,n,o,a,s,e,i,r)}),l.rect||(l.rect=l.quadPoints.slice(0,4)),l.rect.length<4||("highlight"==e.type?P.createHighlightAnnotation(l):"underline"==e.type?P.createUnderlineAnnotation(l):"strokeout"==e.type?P.createStrikeOutAnnotation(l):"image"==e.type&&(l.opacity=.3,l.quadPoints.length&&(l.rect=[l.quadPoints[2],l.quadPoints[3],l.quadPoints[4],l.quadPoints[5]],P.createSquareAnnotation(l))));else if("ink"==e.type){var n,e=e.position.paths;l.inkList=[];for(n of e)l.inkList.push(n.slice());delete l.quadPoints,l.rect||(l.rect=[0,0,0,0]),P.createInkAnnotation(l)}}});new Date;t=P.write(),C++,setTimeout(function(){window.parent.postMessage({type:"exportAnnotatePDF",pdfData:t,_viewMark:g},"*")},200)},200);break;case"getAnnotations":P&&P.getAnnotations().then(e=>{window.parent.postMessage({type:"gteAnnotations",_viewMark:g},"*")});break;case"saveImagePath":var o=n.data.id,a=n.data.imagePath;u.forEach(e=>{e.id==o&&(e.imageAbsolutePath=a)}),Ie();break;case"useOldVersion":q=!0;break;case"useNewVersion":q=!1}var s},!1);var re={yellow:"247,255,0",green:"125,240,102",blue:"143,222,249",pink:"247,153,209",red:"253,73,73"},se=null;function le(t){if(!t.target||!t.target.closest(".selectBox")){ie();let e=Le(t.target);!e||(n=e.node.querySelector(".selectBox"))&&n.parentElement&&(n.onmousedown=null,n.ontouchstart=null,n.parentElement.removeChild(n));var n=ke(t);n&&(pdfViewer._currentPage=n.pageIndex+1,extractor.getSortIndex(n),function(t,e){ce.current=t,ce.id="";var n,o,a,{action:i,selectAnnotations:r}=ge(t);r&&r.length?(oe(h=r[r.length-1]),Q(h.id),window.parent.postMessage({type:"showNewMindmapAnnotate",id:h.id,data:h,annotateType:h.type,mdId:f,_viewMark:g},"*")):(se=t,"ink"!=i.type?"image"!=i.type||(o=(e.touches?e.touches[0]:e).clientX,n=(e.touches?e.touches[0]:e).clientY,X=[o,n],i.annotation={id:Te(),type:"rect",color:`rgb(${s})`,position:{pageIndex:se.pageIndex,rects:[t.rects[0].slice()]},dateCreated:Date.now(),dateModified:Date.now(),pdfName:k},i._page=ae.find(e=>e.pageIndex==t.pageIndex),(a=document.createElement("div")).style.position="absolute",a.style.background="rgba(255,171,46,0.6)",r=i._page.page.originalPage.div.getBoundingClientRect(),o=o-r.left,r=n-r.top,b=w=0,a.style.left=o+"px",a.style.top=r+"px",(e=e.target.closest(".textLayer"))&&e.appendChild(a),i._rectDom=a,K=i):(a=t.rects[0].slice(0,2),X=a,i.annotation={id:Te(),type:"ink",color:`rgb(${s})`,position:{pageIndex:t.pageIndex,width:U||2,paths:[[...a]]},dateCreated:Date.now(),dateModified:Date.now(),pdfName:k},i._page=ae.find(e=>e.pageIndex==t.pageIndex),K=i))}(Se(n),t))}}var de={},ce={};function pe(e){de.current=e}function ue(e){var t,n,o,a,i;if(!(t=e.pageIndex,ae.find(e=>e.pageIndex===t)))return null;let r=[];for(o of(n=e.pageIndex,u.filter(e=>e.position.pageIndex===n||e.position.nextPageRects&&e.position.pageIndex+1===n)))"text"===o.type&&o.position.rotation?(i=getRotationTransform(o.position.rects[0],o.position.rotation),a=e.rects[0],a=getBoundingBox(a,inverseTransform(i)),i=o.position.rects[0],quickIntersectRect(a,i)&&r.push(o)):intersectAnnotationWithPoint(o.position,e)&&r.push(o);function s(e){let t=0;for(var n of e.position.rects)t+=(n[2]-n[0])*(n[3]-n[1]);return t}return r.sort((e,t)=>{let n,o;return e.position.rects?n=s(e):e.position.paths&&(n=0),t.position.rects?o=s(t):t.position.paths&&(o=0),n-o}),r}function ge(e){if("ink"===r)return{action:{type:"ink"},selectAnnotations:[]};if("image"===r)return{action:{type:"image"},selectAnnotations:[]};let t=ue(e);e=t;if(e&&1===e.length)return{action:{type:"drag",annotation:t[0]},selectAnnotations:[t[0]]};return t=[],{action:{type:"selectText"},selectAnnotations:t}}function he(n){var o=ke(n);if(se||E){let t=K;if(t){if("image"==t.type){n.preventDefault();var e=(n.touches?n.touches[0]:n).clientX,a=(n.touches?n.touches[0]:n).clientY;return w=e-X[0],b=a-X[1],t._rectDom.style.width=w+"px",void(t._rectDom.style.height=b+"px")}if("ink"==t.type){n.preventDefault();let e=Se(o).rects[0].slice(0,2);return e=addPointToPath(t.annotation.position.paths[0],e),e=e.map(e=>parseFloat(e.toFixed(3))),t.annotation.position.paths[0]=e,t.annotation.position.dateModified=Date.now(),void(!t._page||2<(a=e.length)&&(n=[...X,e[a-2],e[a-1]],t._page.page.renderStroke({color:t.annotation.color,width:t.annotation.position.width,points:n}),X=[e[a-2],e[a-1]]))}}q||o&&se&&function(e){let t=document.getElementById("viewer");t.classList.remove("cursor-pointer"),t.classList.remove("cursor-text"),t.classList.remove("cursor-text-selecting"),ce.current&&(de.current&&de.current.length?pe(function(e,t){if(!e.length)return[];let n=e.find(e=>e.anchor),o={pageIndex:n.position.pageIndex,offset:n.anchorOffset},a={pageIndex:(n=e.find(e=>e.head)).position.pageIndex,offset:n.headOffset};if("left"===t)a.offset--;else if("right"===t)a.offset++;else if("up"===t){if(a.offset=window.extractor.getPrevLineClosestOffset(a.pageIndex,a.offset),null===a.offset)return[]}else if("down"===t){if(a.offset=window.extractor.getNextLineClosestOffset(a.pageIndex,a.offset),null===a.offset)return[]}else"object"==typeof t&&(t=t,a=t);return Ee(o,a)}(de.current,e)):pe(Ee(ce.current,e)));(function(e){m.length&&(m.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),m=[]);{var t,n,o,a;e&&e.current&&e.current.length&&e.current[0].position&&(e.current[0].position=Ce(e.current[0].position),t=e.current[0].position.rects,e.current[0].position.rects.map(e=>{e[1]&&(e[1]=e[1]-I),e[3]&&(e[3]=e[3]+A)}),o=e.current[0].position.pageIndex+1,(a=R.querySelector(`[data-page-number="${o}"]`).querySelector(".textLayer"))&&(a.querySelector(".annotateLayer-extend")?n=a.querySelector(".annotateLayer-extend"):((n=document.createElement("div")).classList.add("annotateLayer-extend"),a.appendChild(n)),o=e.current[0].text,a=Te(),e.current[0].id=a,t&&t.length&&fe(t,n,o,a)))}})(de),me()}(Se(o))}else o?(o=ge(Se(o))["action"],t(o)):t()}function t(e){let t="default";var n,o,a;e&&("overlay"===e.type?t="pointer":"updateAnnotationRange"===e.type?t=e.triggered?"text":e.vertical?"ns-resize":"ew-resize":"resize"===e.type?e.annotation.position.rotation?t="move":["l","r"].includes(e.dir)?t="ew-resize":["t","b"].includes(e.dir)?t="ns-resize":["tl","br"].includes(e.dir)?t="nwse-resize":["bl","tr"].includes(e.dir)&&(t="nesw-resize"):"move"===e.type?t="grab":"rotate"===e.type?t="move":"ink"===e.type?t="crosshair":"erase"===e.type?([n,o]=this._iframeWindow.PDFViewerApplication.pdfViewer._pages[0].viewport.transform,a=Math.hypot(n,o),o=(n=this._tool.size*a)*window.devicePixelRatio,a=+window.devicePixelRatio,t=`url('${`data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${n}" viewBox="0 0 ${o} ${o}"><circle cx="${o/2}" cy="${o/2}" r="${(o-a)/2}" stroke="black" stroke-width="${a}" fill="none" /></svg>`}') ${n/2} ${n/2}, auto`):["selectText"].includes(e.type)&&(t="text"));let i=document.getElementById("viewerContainer");i.style.cursor=t}function me(){document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()}function fe(e,n,o,a){e.forEach(e=>{var t=document.createElement("div");t.classList.add("mm-highlight"),t.classList.add("annotate"),t.style.left=e[0]+"px",t.style.top=e[1]+"px",t.style.width=e[2]-e[0]+"px",t.style.height=e[3]-e[1]+"px",t.style.backgroundColor="rgba(0,0,255,0.3)",t.setAttribute("data-text",o),t.setAttribute("data-type","highlight"),t.setAttribute("data-id",a),m.push(t),n.appendChild(t)})}function ye(e){0,se=null;let o=K;if(o){if("ink"==o.type&&o.annotation){var t,a,i;if(e.preventDefault(),J&&(t=getPositionBoundingRect(J.position),a=getPositionBoundingRect(o.annotation.position),a=distanceBetweenRects(t,a)),J&&J.position.pageIndex==o.annotation.position.pageIndex&&Date.now()-J.dateModified<1e4&&a<50){let{id:t,position:e}=J,n=J.position.paths.slice();o.annotation.position.paths[0]&&2<o.annotation.position.paths[0].length&&(n.push(o.annotation.position.paths[0]),e={...e,paths:n},!(a=u.find(e=>e.id==t))||-1<(r=u.indexOf(a))&&(u.splice(r,1),(i=JSON.parse(JSON.stringify(a))).position=e,i.dateModified=Date.now(),u.find(e=>e.id==i.id)||u.splice(r,0,i),J=i,o._page&&(o._page.page.render(),be(o._page,J,!1,i.path))))}else{if(o.annotation.position.paths&&1==o.annotation.position.paths.length&&o.annotation.position.paths[0]&&o.annotation.position.paths[0].length<=2)return void(K=null);J={id:o.annotation.id,type:"ink",color:`rgb(${s})`,position:{pageIndex:o.annotation.position.pageIndex,width:o.annotation.position.width,paths:o.annotation.position.paths.slice()},dateCreated:o.annotation.dateCreated,dateModified:Date.now(),pdfName:k},u.find(e=>e.id==J.id)||u.push(J),o._page&&(o._page.page.render(),be(o._page,J,!0))}return o.annotation=null,void(K=null)}if("image"==o.type&&o.annotation){var r={x:parseFloat(o._rectDom.style.left),y:parseFloat(o._rectDom.style.top),w:parseFloat(o._rectDom.style.width),h:parseFloat(o._rectDom.style.height)};if(!r.w||!r.h)return;r.w<20&&(r.w=20),r.h<20&&(r.h=20);r=Se({pageIndex:o.annotation.position.pageIndex,rects:[[r.x,r.y,r.x+r.w,r.y+r.h]]});return r&&r.rects.length&&(r={id:o.annotation.id,type:"image",color:`rgb(${s})`,position:{pageIndex:o.annotation.position.pageIndex,rects:[r.rects[0].slice()]},dateCreated:Date.now(),dateModified:Date.now(),pdfName:k},u.push(r),o._page&&(o._page.page.render(),be(o._page,r,!0))),o._rectDom.parentElement&&o._rectDom.parentElement.removeChild(o._rectDom),o.annotation=null,void(K=null)}}q&&(ve(),me()),function(e){{var o,a;a=e.changedTouches?(o=e.changedTouches[0].pageX,e.changedTouches[0].pageY):(o=e.pageX,e.pageY)}!h;setTimeout(()=>{if(ve(0,!0),me(),m.length||h){try{var e;m.length?(m[0]&&(e=m[0].getAttribute("data-text")),z.style=`left:${o-100}px;top:${a+20}px`,z.style.display="flex"):h&&("highlight"!=h.type&&"underline"!=h.type&&"strokeout"!=h.type||(e=h.text),_.style=`left:${o-100}px;top:${a+40}px`,_.style.display="flex")}catch(e){console.log(e)}var t,n;l&&e&&("google"==p||(d&&c&&(t=0<o-140?o-140:20,n=m.length?parseFloat(z.style.top):parseFloat(_.style.top),W.style.left=`${t}px`,W.style.top=`${n+30}px`,W.style.display="block",H.innerText="..."),baiduTranslate(d,c,e,"zh",function(e){e&&e.trans_result&&e.trans_result.length?(H.innerText=e.trans_result[0].dst,e=W.clientHeight,document.body.clientHeight-a-50-e<0&&(W.style.top=`${a-e-30}px`),t+W.clientWidth>document.body.clientWidth&&(W.style.left=document.body.clientWidth-W.clientWidth-10+"px")):H.innerText="translate fail"})))}},20)}(e)}function ve(e,t){var n=window.getSelection();if(!n.isCollapsed){for(var o=n.getRangeAt(0),a=o.getClientRects(),i="",r=o.cloneContents(),s=0;s<r.children.length;s++)i+=r.children[s].textContent+" ";var i=(i=i.trim())||n.toString(),a=function(e){for(var t={1:[e[0]]},n=1,o=e[0].bottom,a=1;a<e.length;a++){t[n]||(t[n]=[]);var i=e[a].height;e[a].top<o&&e[a].bottom<o+i/3||(t[++n]||(t[n]=[]),o=e[a].bottom),t[n].push(e[a])}var r,s=[];for(r in t){let n,o,a,i;t[r].forEach((e,t)=>{0==t?(n=e.x,o=e.y,a=e.bottom,i=e.right):(e.x<n&&(n=e.x),e.y<o&&(o=e.y),e.bottom>a&&(a=e.bottom),e.right>i&&(i=e.right))});var l={x:n,y:o,top:n,left:o,bottom:a,right:i,width:i-n,height:a-o};s.push(l)}return s}(a=function(t){var n=[];for(let e=0;e<t.length;e++)for(var o,a,i=e;i<t.length;i++)e!=i&&(o=t[e],a=t[i],o.x<=a.x&&o.y<=a.y&&o.bottom>=a.bottom&&o.right>=a.right&&n.push(i));var r=[];{if(n.length){for(let e=0;e<t.length;e++)-1==n.indexOf(e)&&r.push(t[e]);return r}return t}}(a)),l=De(),r=[];a.forEach(e=>{var t=e.x-l.left,n=e.y-l.top;r.push([t,n,t+e.width,n+e.height])});a=ce.current.pageIndex;ce.rects=r,ce.id=Te(),ce.selectText=i;var d,a=a+1,a=R.querySelector(`[data-page-number="${a}"]`).querySelector(".textLayer");a&&(a.querySelector(".annotateLayer-extend")?d=a.querySelector(".annotateLayer-extend"):((d=document.createElement("div")).classList.add("annotateLayer-extend"),a.appendChild(d)),m.length&&(m.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),m=[]),fe(r,d,i,ce.id),t&&(v=!0))}}function xe(e,t){var n,o,a,i;a=q||v?(i=ce.rects,n=ce.selectText,o=ce.id,ce.current.pageIndex):(i=de.current[0].position.rects,n=de.current[0].text,o=de.current[0].id,de.current[0].position.pageIndex),o&&(t=`rgb(${t||s})`,i=Se({pageIndex:a,rects:i}),i={text:n,id:o,type:e||"highlight",pdfName:k,color:t,position:{pageIndex:a,rects:i.rects},dateCreated:Date.now(),dateModified:Date.now()},u.push(i),we(i),Ie(i),ie(),m=[],de={},ce.id="",_.style.display="none",N.style.display="none",v=!1)}function we(e){var t=e||selectAnnotation;if(t){e=ae.find(e=>e.pageIndex==t.position.pageIndex);if(e)try{e.page.render(),t.position.nextPageRects&&(e=ae.find(e=>e.pageIndex==t.position.pageIndex+1))&&e.page.render()}catch(e){}"image"!=t.type&&"ink"!=t.type||be(e,t,!1,t.path)}}function be(e,t,n,o){var a;o||(i=+new Date,o=M?M+"/"+i+".png":k.startsWith("file:")?(a=S.lastIndexOf("/"),S.substr(0,a+1)+i+".png"):(a=k.lastIndexOf("/"),k.substr(0,a+1)+L+"-"+i+".png"),t.path=o);var i=e.page.getImageByAnnotation(t);i&&(e=$e(i.data.replace(/^data:image\/\w+;base64,/,"")),window.parent.postMessage({type:"createNewRect",imagePath:o,dataBuffer:e,annotations:u,isNew:n,data:t,imageOptions:{width:i.width,height:i.height},_viewMark:g,mdId:f},"*"))}function Ie(e){u.sort((e,t)=>e.position?.pageIndex-t.position?.pageIndex),Ae(),window.parent.postMessage({type:"saveNewAnnotations",_viewMark:g,annotations:u,newAnnotate:e,mdId:f},"*")}function Ae(){setTimeout(()=>{document.querySelector("#outerContainer").classList.contains("sidebarOpen")&&document.querySelector("#showAnnotation").classList.contains("toggled")&&(F.innerHTML="",u.forEach(e=>{var t=document.createElement("div");t.classList.add("annotate-item"),t.setAttribute("data-id",e.id);var n=document.createElement("div");n.classList.add("annotate-item-container"),t.appendChild(n);var o=document.createElement("div");o.classList.add("annotate-item-header"),a=("zh-cn"==D?V[D]:V.zn).page,o.innerHTML=`${a} ${e.position.pageIndex+1}`;var a=document.createElement("div");a.classList.add("annotate-item-content"),"highlight"==e.type||"underline"==e.type||"strokeout"==e.type?a.innerHTML=`
								<blockquote>
									${e.text||""}
								</blockquote>
						   `:(i=`<img src="${e.imageAbsolutePath||e.path}"/>`,a.innerHTML=i);var i=document.createElement("div");i.classList.add("annotate-item-note"),i.innerText=`${e.comments||""}`;var r,s=e.color,l="mm-highlight-black";for(r in re)if(-1<s.indexOf(re[r])){l=`mm-highlight-${r}`;break}t.classList.add(l),n.appendChild(o),n.appendChild(a),n.appendChild(i),F.appendChild(t)}))},10)}function ke(e){let t=Le(e.target);if(!t)return null;var n=t.node.getBoundingClientRect(),o=(e.touches?e.touches[0]:e).clientX,e=(e.touches?e.touches[0]:e).clientY,o=o+t.node.scrollLeft-n.left-9,n=e+t.node.scrollTop-n.top-10;return{pageIndex:t.number-1,rects:[[o,n,o,n]]}}function Le(e){e=e.closest("#viewer > .page")||e.closest("#viewer > .spread > .page");return e?{node:e,number:parseInt(e.dataset.pageNumber)}:null}function Se(e){var a,t=pdfViewer.getPageView(e.pageIndex).viewport;return a=t,{pageIndex:e.pageIndex,rects:e.rects.map(e=>{var[t,n]=a.convertToPdfPoint(e[0],e[1]),[o,e]=a.convertToPdfPoint(e[2],e[3]);return[Math.min(t,o),Math.min(e,n),Math.max(t,o),Math.max(e,n)]})}}function Ce(e){return function(e,i){{if(e.rects)return{pageIndex:e.pageIndex,rects:e.rects.map(e=>{var[t,n]=i.convertToViewportPoint(e[0],e[1]),[o,e]=i.convertToViewportPoint(e[2],e[3]);return[Math.min(t,o),Math.min(e,n),Math.max(t,o),Math.max(e,n)]})};if(e.paths)return{pageIndex:e.pageIndex,width:e.width*i.scale,paths:e.paths.map(t=>{let n=[];for(let e=0;e<t.length-1;e+=2){var o=t[e],a=t[e+1];n.push(...i.convertToViewportPoint(o,a))}return n})}}}(e,pdfViewer.getPageView(e.pageIndex).viewport)}$("body").on("blur",".annotate-item-note",e=>{var t,n,o=e.target,a=o.innerText,i=o.closest(".annotate-item").getAttribute("data-id");i&&(u.forEach(e=>{var t;e.id==i&&((t=JSON.parse(e.text)).contents=a,t.commentTime=+new Date,e.text=JSON.stringify(t))}),t=i,e=a,(o=R.querySelector(`.annotate[data-id="${t}"]`))&&(t=o.querySelector(".comment-bar"),e?t?t.setAttribute("data-title",e):((n=document.createElement("span")).classList.add("comment-bar"),n.style="position:abaolute;left:-8px;top:-6px;z-index:120;",n.innerHTML=B,n.setAttribute("data-title",e),o.appendChild(n)):(n=o.querySelector(".comment-bar"))&&o.removeChild(n),Ie()))}),O.onblur=()=>{var t=N.selectId,n=null;u.forEach(e=>{e.id==t&&(e.comments=O.value,(n=e).commentTime=Date.now())}),we(n),O.value="",N.selectId="",ie(),Ie()};function Ee(a,i){let r=[];var e=Math.min(a.pageIndex,i.pageIndex),t=Math.max(a.pageIndex,i.pageIndex),s=a.pageIndex>i.pageIndex;for(let o=e;o<=t;o++){let e,t;o===a.pageIndex&&(e=void 0!==a.offset?a.offset:[a.rects[0][0],a.rects[0][1]]),o===i.pageIndex&&(t=void 0!==i.offset?i.offset:[i.rects[0][0],i.rects[0][1]]);let n=window.extractor.extractRange({pageIndex:o,anchor:e,head:t,reverse:s});if(!n)return[];if(o===a.pageIndex&&(n.anchor=!0),o===i.pageIndex&&(n.head=!0),!n.collapsed){let e=pdfViewer.getPageView(n.position.pageIndex).viewport.viewBox[3]-n.position.rects[0][3];e<0&&(e=0);let t=Math.min(n.anchorOffset,n.headOffset);n.sortIndex=[o.toString().slice(0,5).padStart(5,"0"),t.toString().slice(0,6).padStart(6,"0"),Math.floor(e).toString().slice(0,5).padStart(5,"0")].join("|")}r.push(n)}return r}function Te(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()}function Me(e){var t,n=e.id-1;t=e.id-1,ae=ae.filter(e=>e.pageIndex!=t);e=new Page(e);e._annotations=u,e._noteImage=o,ae.push({pageIndex:n,page:e}),e.render(),i&&(ie(),qe(i),i="")}function Pe(e){Me(e.source)}function qe(t){var n;ie(),u.length&&(n=null,u.forEach(e=>{e.id==t&&(n=e)}),n&&(pdfViewer.currentPageNumber!=n.position.pageIndex+1&&(Y&&(Y.parentElement&&Y.parentElement.removeChild(Y),Y.onmousedown=null,Y.ontouchstart=null,Y=null),pdfViewer.currentPageNumber=n.position.pageIndex+1,i=n.id),setTimeout(()=>{oe(n),Q(n.id);var e=Y.getBoundingClientRect(),t=document.querySelector("#viewerContainer");e.top<0&&(a=!0,ie(),t.scrollTop=t.scrollTop+e.top-100,oe(n),Q(n.id),setTimeout(()=>{a=!1},10)),e.top>t.clientHeight-100&&(a=!0,ie(),t.scrollTop=t.scrollTop+e.top-100,oe(n),Q(n.id),setTimeout(()=>{a=!1},10))},200)))}function De(){if(0<=pdfViewer._currentPage){var e=document.querySelector(`.page[data-page-number="${pdfViewer._currentPage}"]`);if(e){e=e.querySelector("canvas").getBoundingClientRect();return{top:e.top,left:e.left}}return{top:0,left:0}}return{left:0,top:0}}function $e(e){for(var t=window.atob(e),n=t.length,o=new Uint8Array(n),a=0;a<n;a++)o[a]=t.charCodeAt(a);return o.buffer}});